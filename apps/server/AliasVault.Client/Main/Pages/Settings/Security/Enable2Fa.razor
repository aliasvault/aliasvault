@page "/settings/security/enable-2fa"
@using AliasVault.Client.Main.Pages.Settings.Security.Components
@using Microsoft.Extensions.Localization
@inherits MainBase
@inject HttpClient Http

<LayoutPageTitle>@_pageTitle</LayoutPageTitle>

<div class="grid grid-cols-1 px-4 pt-6 xl:grid-cols-3 xl:gap-4 dark:bg-gray-900">
    <div class="mb-4 col-span-full xl:mb-2">
        <Breadcrumb BreadcrumbItems="BreadcrumbItems"/>
        <H1>@_pageTitle</H1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">@_pageDescription</p>
    </div>
</div>

@if (IsLoading)
{
    <LoadingIndicator />
}
else if (RecoveryCodes is not null)
{
    <ShowRecoveryCodes RecoveryCodes="RecoveryCodes.ToArray()"/>
}
else
{
    <div class="p-4 mb-4  mx-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800">
        <div class="space-y-6">
            <div id="authenticator-uri" data-url="@QrCodeUrl" class="flex justify-center">
                <!-- QR code will be rendered here -->
            </div>

            <p class="text-sm text-gray-600 text-center">
                @_qrCodeInstructions
            </p>
            <div class="text-lg font-mono text-center bg-gray-100 p-2 rounded" id="authenticator-secret">@Secret</div>

            <EditForm Model="@VerifyModel" OnValidSubmit="@VerifySetup" class="space-y-4">
                <div>
                    <InputText id="verificationCode" @bind-Value="VerifyModel.Code"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="@_verificationCodePlaceholder"/>
                </div>
                <button type="submit"
                        class="w-full bg-primary-500 text-white py-2 px-4 rounded-md hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    @_verifyAndEnableButton
                </button>
            </EditForm>
        </div>
    </div>
}

@code {
    private string QrCodeUrl { get; set; } = string.Empty;
    private string Secret { get; set; } = string.Empty;
    private bool IsLoading { get; set; } = true;
    private List<string>? RecoveryCodes { get; set; }
    private readonly VerificationModel VerifyModel = new();

    private IStringLocalizer? _localizer;
    private IStringLocalizer Localizer => _localizer ??= LocalizerFactory.Create("Components.Main.Pages.Settings.Security.Enable2Fa", "AliasVault.Client");
    
    // Cached localized strings
    private string _pageTitle = string.Empty;
    private string _pageDescription = string.Empty;
    private string _breadcrumbSecuritySettings = string.Empty;
    private string _breadcrumbEnable2Fa = string.Empty;
    private string _qrCodeInstructions = string.Empty;
    private string _verificationCodePlaceholder = string.Empty;
    private string _verifyAndEnableButton = string.Empty;
    private string _twoFactorEnabledSuccess = string.Empty;
    private string _failedToEnable2Fa = string.Empty;

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Initialize localized strings once
        _pageTitle = Localizer["PageTitle"];
        _pageDescription = Localizer["PageDescription"];
        _breadcrumbSecuritySettings = Localizer["BreadcrumbSecuritySettings"];
        _breadcrumbEnable2Fa = Localizer["BreadcrumbEnable2Fa"];
        _qrCodeInstructions = Localizer["QrCodeInstructions"];
        _verificationCodePlaceholder = Localizer["VerificationCodePlaceholder"];
        _verifyAndEnableButton = Localizer["VerifyAndEnableButton"];
        _twoFactorEnabledSuccess = Localizer["TwoFactorEnabledSuccess"];
        _failedToEnable2Fa = Localizer["FailedToEnable2Fa"];
        
        BreadcrumbItems.Add(new BreadcrumbItem { DisplayName = _breadcrumbSecuritySettings, Url = "/settings/security" });
        BreadcrumbItems.Add(new BreadcrumbItem { DisplayName = _breadcrumbEnable2Fa });
    }

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        // Check on server if 2FA is enabled
        if (firstRender)
        {
            // Get the QR code and secret for the authenticator app.
            var response = await Http.PostAsync("v1/TwoFactorAuth/enable", null);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<TwoFactorSetupResult>();

                if (result != null)
                {
                    QrCodeUrl = result.QrCodeUrl;

                    // Make secret more readable by adding spaces every 4 characters
                    Secret = string.Join(" ", Enumerable.Range(0, result.Secret.Length / 4)
                        .Select(i => result.Secret.Substring(i * 4, 4))).ToLower();

                    IsLoading = false;
                    StateHasChanged();
                    await JsInteropService.GenerateQrCode("authenticator-uri");
                }
            }

            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task VerifySetup()
    {
        var response = await Http.PostAsJsonAsync("v1/TwoFactorAuth/verify", VerifyModel.Code);
        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<TwoFactorVerifyResult>();

            if (result != null)
            {
                GlobalNotificationService.AddSuccessMessage(_twoFactorEnabledSuccess, true);

                // Show recovery codes.
                RecoveryCodes = result.RecoveryCodes;
                IsLoading = false;
                StateHasChanged();
                return;
            }
        }

        GlobalNotificationService.AddErrorMessage(_failedToEnable2Fa, true);
        StateHasChanged();
    }

    private sealed class TwoFactorSetupResult
    {
        public required string Secret { get; init; } = string.Empty;
        public required string QrCodeUrl { get; init; } = string.Empty;
    }

    private sealed class TwoFactorVerifyResult
    {
        public required List<string> RecoveryCodes { get; init; } = [];
    }

    private sealed class VerificationModel
    {
        public string Code { get; set; } = string.Empty;
    }
}
