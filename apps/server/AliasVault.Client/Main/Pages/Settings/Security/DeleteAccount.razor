@page "/settings/security/delete-account"
@inherits MainBase
@using System.Text.Json
@using AliasVault.Client.Utilities
@using AliasVault.Shared.Models.WebApi.Auth
@using AliasVault.Cryptography.Client
@using SecureRemotePassword
@using System.ComponentModel.DataAnnotations
@using Microsoft.Extensions.Localization
@using AliasVault.Client.Resources
@inject HttpClient Http

<LayoutPageTitle>@_pageTitle</LayoutPageTitle>

<div class="grid grid-cols-1 px-4 pt-6 xl:grid-cols-3 xl:gap-4 dark:bg-gray-900">
    <div class="mb-4 col-span-full xl:mb-2">
        <Breadcrumb BreadcrumbItems="BreadcrumbItems"/>
        <H1>@_pageTitle</H1>
    </div>
</div>

<div class="p-4 mb-4 mx-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-gray-800">
    @if (!_showPasswordConfirm)
    {
        <div class="mb-6">
            <MessageWarning Message="@_permanentActionWarning" />

            <div class="mt-4 mb-6 text-gray-600 dark:text-gray-400">
                <p class="mb-2">@_pleaseNote</p>
                <ul class="list-disc list-inside space-y-2">
                    <li>@_vaultsDeletedNote</li>
                    <li>@_emailAliasesOrphanedNote</li>
                    <li>@_accountCannotBeRecoveredNote</li>
                </ul>
            </div>

            <EditForm Model="@_usernameModel" OnSubmit="@ConfirmUsername">
                <div class="mb-4">
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">@_confirmUsernameLabel</label>
                    <InputText id="username" @bind-Value="_usernameModel.Username" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" />
                </div>

                <div class="flex space-x-3">
                    <Button Type="submit" Color="danger">@_continueWithAccountDeletion</Button>
                    <Button Type="button" Color="secondary" OnClick="Cancel">Cancel</Button>
                </div>
            </EditForm>
        </div>
    }
    else
    {
        <div class="mb-6">
            <MessageWarning Message="@_finalWarning" />

            <div class="mt-4 mb-6 text-gray-600 dark:text-gray-400">
                <p class="mb-2">@_pleaseNote</p>
                <ul class="list-disc list-inside space-y-2">
                    <li>@_deletionIrreversibleNote</li>
                </ul>
            </div>

            <EditForm Model="@_passwordModel" OnValidSubmit="@DeleteAccountConfirmed">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-4">
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">@_enterPasswordLabel</label>
                    <InputText id="password" type="password" @bind-Value="_passwordModel.Password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" />
                </div>

                <div class="flex space-x-3">
                    <Button Type="submit" Color="danger">@_deleteMyAccount</Button>
                    <Button Type="button" Color="secondary" OnClick="Cancel">Cancel</Button>
                </div>
            </EditForm>
        </div>
    }
</div>

@code {
    /// <summary>
    /// The model for the username confirmation step.
    /// </summary>
    private readonly DeleteAccountUsernameModel _usernameModel = new();

    /// <summary>
    /// The model for the password confirmation step.
    /// </summary>
    private readonly DeleteAccountPasswordModel _passwordModel = new();

    private IStringLocalizer? _localizer;
    private IStringLocalizer Localizer => _localizer ??= LocalizerFactory.Create("Components.Main.Pages.Settings.Security.DeleteAccount", "AliasVault.Client");
    private IStringLocalizer? _apiErrorLocalizer;
    private IStringLocalizer ApiErrorLocalizer => _apiErrorLocalizer ??= LocalizerFactory.Create("ApiErrors", "AliasVault.Client");

    // Cached localized strings for performance
    private string _pageTitle = string.Empty;
    private string _breadcrumbSecuritySettings = string.Empty;
    private string _breadcrumbDeleteAccount = string.Empty;
    private string _permanentActionWarning = string.Empty;
    private string _pleaseNote = string.Empty;
    private string _vaultsDeletedNote = string.Empty;
    private string _emailAliasesOrphanedNote = string.Empty;
    private string _accountCannotBeRecoveredNote = string.Empty;
    private string _confirmUsernameLabel = string.Empty;
    private string _continueWithAccountDeletion = string.Empty;
    private string _finalWarning = string.Empty;
    private string _deletionIrreversibleNote = string.Empty;
    private string _enterPasswordLabel = string.Empty;
    private string _deleteMyAccount = string.Empty;
    private string _usernameRequired = string.Empty;
    private string _usernameDoesNotMatch = string.Empty;
    private string _deletingAccountMessage = string.Empty;
    private string _errorProcessingRequest = string.Empty;

    /// <summary>
    /// Whether to show the password confirmation step.
    /// </summary>
    private bool _showPasswordConfirm;

    /// <summary>
    /// The ephemeral client for SRP.
    /// </summary>
    private SrpEphemeral ClientEphemeral { get; set; } = null!;

    /// <summary>
    /// The session client for SRP.
    /// </summary>
    private SrpSession ClientSession { get; set; } = null!;

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Cache localized strings for performance
        _pageTitle = Localizer["PageTitle"];
        _breadcrumbSecuritySettings = Localizer["BreadcrumbSecuritySettings"];
        _breadcrumbDeleteAccount = Localizer["BreadcrumbDeleteAccount"];
        _permanentActionWarning = Localizer["PermanentActionWarning"];
        _pleaseNote = Localizer["PleaseNote"];
        _vaultsDeletedNote = Localizer["VaultsDeletedNote"];
        _emailAliasesOrphanedNote = Localizer["EmailAliasesOrphanedNote"];
        _accountCannotBeRecoveredNote = Localizer["AccountCannotBeRecoveredNote"];
        _confirmUsernameLabel = Localizer["ConfirmUsernameLabel"];
        _continueWithAccountDeletion = Localizer["ContinueWithAccountDeletion"];
        _finalWarning = Localizer["FinalWarning"];
        _deletionIrreversibleNote = Localizer["DeletionIrreversibleNote"];
        _enterPasswordLabel = Localizer["EnterPasswordLabel"];
        _deleteMyAccount = Localizer["DeleteMyAccount"];
        _usernameRequired = Localizer["UsernameRequired"];
        _usernameDoesNotMatch = Localizer["UsernameDoesNotMatch"];
        _deletingAccountMessage = Localizer["DeletingAccountMessage"];
        _errorProcessingRequest = Localizer["ErrorProcessingRequest"];

        BreadcrumbItems.Add(new BreadcrumbItem { DisplayName = _breadcrumbSecuritySettings, Url = "/settings/security" });
        BreadcrumbItems.Add(new BreadcrumbItem { DisplayName = _breadcrumbDeleteAccount });
    }

    /// <summary>
    /// Confirms the username for account deletion.
    /// </summary>
    private async Task ConfirmUsername()
    {
        GlobalNotificationService.ClearMessages();

        if (string.IsNullOrEmpty(_usernameModel.Username))
        {
            GlobalNotificationService.AddErrorMessage(_usernameRequired, true);
            return;
        }

        var username = await GetUsernameAsync();
        var usernameMatches = string.Equals(_usernameModel.Username.Trim(), username.Trim(), StringComparison.OrdinalIgnoreCase);
        if (!usernameMatches)
        {
            GlobalNotificationService.AddErrorMessage(_usernameDoesNotMatch, true);
            return;
        }

        _showPasswordConfirm = true;
        StateHasChanged();
    }

    /// <summary>
    /// Confirms the password via WebApi and if valid deletes the account permanently.
    /// </summary>
    private async Task DeleteAccountConfirmed()
    {
        GlobalLoadingSpinner.Show(_deletingAccountMessage);
        GlobalNotificationService.ClearMessages();

        try
        {
            // First verify the current password.
            var username = await GetUsernameAsync();
            var result = await Http.PostAsJsonAsync("v1/Auth/delete-account/initiate", new LoginInitiateRequest(username));
            var responseContent = await result.Content.ReadAsStringAsync();

            if (!result.IsSuccessStatusCode)
            {
                foreach (var error in ApiResponseUtility.ParseErrorResponse(responseContent, ApiErrorLocalizer))
                {
                    GlobalNotificationService.AddErrorMessage(error, true);
                }
                return;
            }

            var loginResponse = JsonSerializer.Deserialize<LoginInitiateResponse>(responseContent);
            if (loginResponse == null)
            {
                GlobalNotificationService.AddErrorMessage(_errorProcessingRequest, true);
                return;
            }

            // Verify password using SRP
            var passwordHash = await Encryption.DeriveKeyFromPasswordAsync(_passwordModel.Password, loginResponse.Salt, loginResponse.EncryptionType, loginResponse.EncryptionSettings);
            var passwordHashString = BitConverter.ToString(passwordHash).Replace("-", string.Empty);

            ClientEphemeral = Srp.GenerateEphemeralClient();
            var privateKey = Srp.DerivePrivateKey(loginResponse.Salt, username, passwordHashString);
            ClientSession = Srp.DeriveSessionClient(
                privateKey,
                ClientEphemeral.Secret,
                loginResponse.ServerEphemeral,
                loginResponse.Salt,
                username);

            // Send final delete request with SRP proof.
            result = await Http.PostAsJsonAsync("v1/Auth/delete-account/confirm", new DeleteAccountRequest(username, ClientEphemeral.Public, ClientSession.Proof));
            responseContent = await result.Content.ReadAsStringAsync();

            if (!result.IsSuccessStatusCode)
            {
                foreach (var error in ApiResponseUtility.ParseErrorResponse(responseContent, ApiErrorLocalizer))
                {
                    GlobalNotificationService.AddErrorMessage(error, true);
                }
                return;
            }

            // Account deleted successfully, redirect to logout page.
            NavigationManager.NavigateTo("/user/logout");
        }
        finally
        {
            GlobalLoadingSpinner.Hide();
        }
    }

    /// <summary>
    /// Cancels the account deletion process.
    /// </summary>
    private void Cancel()
    {
        NavigationManager.NavigateTo("/settings/security");
    }

    /// <summary>
    /// Model for the username confirmation step.
    /// </summary>
    public class DeleteAccountUsernameModel
    {
        /// <summary>
        /// Gets or sets the username.
        /// </summary>
        [Required(ErrorMessageResourceType = typeof(ValidationMessages), ErrorMessageResourceName = nameof(ValidationMessages.UsernameRequired))]
        public string Username { get; set; } = string.Empty;
    }

    /// <summary>
    /// Model for the password confirmation step.
    /// </summary>
    public class DeleteAccountPasswordModel
    {
        /// <summary>
        /// Gets or sets the password.
        /// </summary>
        [Required(ErrorMessageResourceType = typeof(ValidationMessages), ErrorMessageResourceName = nameof(ValidationMessages.PasswordRequired))]
        public string Password { get; set; } = string.Empty;
    }
}
