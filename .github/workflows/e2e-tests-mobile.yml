# Mobile E2E tests (iOS and Android) on self-hosted Mac Mini M4
#
# RUNNER SETUP REQUIREMENTS:
# This workflow requires a self-hosted macOS runner with the following:
#
# 1. Runner label: macOS-ci
#
# 2. Pre-installed dependencies:
#    - Node.js 20+
#    - .NET SDK 9.0
#    - Rust with targets: aarch64-apple-ios, aarch64-apple-ios-sim, x86_64-apple-ios,
#                         aarch64-linux-android, armv7-linux-androideabi, x86_64-linux-android, i686-linux-android
#    - Xcode (latest stable)
#    - CocoaPods
#    - Android SDK with NDK 26.1.10909125
#    - Android emulator AVD named "Pixel_Pro_API_36" (arm64-v8a for M4)
#    - Docker Desktop
#
# 3. Development database running:
#    ./install.sh configure-dev-db start
#
# 4. Environment variables in runner's shell profile:
#    export ANDROID_HOME="$HOME/Library/Android/sdk"
#    export ANDROID_SDK_ROOT="$ANDROID_HOME"
#    export ANDROID_NDK_HOME="$ANDROID_HOME/ndk/26.1.10909125"
#    export PATH="$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$HOME/.cargo/bin"
#
name: E2E Tests - Mobile

on:
  push:
    branches: [ "main" ]
    paths:
      - 'apps/mobile-app/**'
      - 'core/**'
      - '.github/workflows/e2e-tests-mobile.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'apps/mobile-app/**'
      - 'core/**'
      - '.github/workflows/e2e-tests-mobile.yml'
  workflow_dispatch:

# Only one mobile E2E test run at a time (across all branches/PRs)
# This prevents resource conflicts on the self-hosted runner
concurrency:
  group: mobile-e2e-tests
  cancel-in-progress: false  # Don't cancel running tests, queue instead

# Environment variables for self-hosted runner
env:
  CARGO_HOME: /Users/ci/.cargo
  RUSTUP_HOME: /Users/ci/.rustup
  ANDROID_HOME: /Users/ci/Library/Android/sdk
  ANDROID_SDK_ROOT: /Users/ci/Library/Android/sdk
  ANDROID_NDK_HOME: /Users/ci/Library/Android/sdk/ndk/26.1.10909125
  PATH: /Users/ci/.cargo/bin:/opt/homebrew/bin:/usr/local/bin:/Applications/Docker.app/Contents/Resources/bin:/Users/ci/Library/Android/sdk/platform-tools:/Users/ci/Library/Android/sdk/emulator:/usr/bin:/bin:/usr/sbin:/sbin
  # UTF-8 locale settings required for CocoaPods
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8

jobs:
  # Setup job - verify environment and start shared services
  setup:
    name: Setup Environment
    runs-on: macOS-ci
    timeout-minutes: 10
    outputs:
      ready: ${{ steps.verify.outputs.ready }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false  # Preserve caches

      - name: Cleanup previous run processes
        run: |
          # Kill any leftover processes from previous runs
          pkill -f "dotnet.*AliasVault.Api" || true
          pkill -f "expo start" || true
          pkill -f "metro" || true
          pkill -f "node.*react-native" || true
          # Give processes time to terminate
          sleep 2

      - name: Verify dev database is running
        id: verify
        run: |
          echo "Checking if development database is running..."

          # Check if docker is available
          if ! command -v docker &> /dev/null; then
            echo "::error::Docker is not installed or not in PATH"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if dev database container is running
          if docker compose -f dockerfiles/docker-compose.dev.yml -p aliasvault-dev ps --status running 2>/dev/null | grep -q postgres-dev; then
            echo "âœ… Development database container is running"
          else
            echo "::error::Development database is not running!"
            echo "::error::Please start it manually on the runner with: ./install.sh configure-dev-db start"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if postgres-dev container is healthy
          if docker compose -f dockerfiles/docker-compose.dev.yml -p aliasvault-dev ps postgres-dev 2>/dev/null | grep -q "healthy"; then
            echo "âœ… Development PostgreSQL container is healthy"
          else
            echo "::error::Development PostgreSQL container is not healthy!"
            echo "::error::Please check the logs with: docker compose -f dockerfiles/docker-compose.dev.yml -p aliasvault-dev logs postgres-dev"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "ready=true" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ Environment ready!"

      - name: Build core libraries
        run: |
          cd core
          chmod +x build-and-distribute.sh
          # Build for both platforms
          ./build-and-distribute.sh --ios --android

      - name: Verify core library distribution
        working-directory: apps/mobile-app
        run: |
          TARGET_DIRS=(
            "utils/dist/core/identity-generator"
            "utils/dist/core/password-generator"
            "utils/dist/core/models"
            "utils/dist/core/vault"
          )
          for dir in "${TARGET_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "Error: Directory $dir does not exist"
              exit 1
            fi
          done
          echo "âœ… Core library distribution verified"

      - name: Install mobile app dependencies
        working-directory: apps/mobile-app
        run: npm ci

      - name: Build API server
        working-directory: apps/server
        run: dotnet build AliasVault.Api

      - name: Start API server
        working-directory: apps/server/AliasVault.Api
        run: |
          dotnet run --no-build > /tmp/api-server.log 2>&1 &
          API_PID=$!
          echo $API_PID > /tmp/api-server.pid

          # Wait for API to be ready
          echo "Waiting for API to start..."
          for i in {1..30}; do
            if curl -s http://localhost:5092/v1/ > /dev/null 2>&1; then
              echo "âœ… API is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "::error::API failed to start within 60 seconds"
              cat /tmp/api-server.log
              exit 1
            fi
            echo "Attempt $i: API not ready yet..."
            sleep 2
          done
        env:
          ConnectionStrings__AliasServerDbContext: "Host=localhost;Port=5433;Database=aliasdb;Username=aliasvault;Password=password"
          JWT_KEY: "12345678901234567890123456789012"
          DATA_PROTECTION_CERT_PASS: "Development"
          PUBLIC_REGISTRATION_ENABLED: "true"
          ADMIN_PASSWORD_HASH: "AQAAAAIAAYagAAAAEKWfKfa2gh9Z72vjAlnNP1xlME7FsunRznzyrfqFte40FToufRwa3kX8wwDwnEXZag=="
          ADMIN_PASSWORD_GENERATED: "2024-01-01T00:00:00Z"
          ASPNETCORE_URLS: "http://0.0.0.0:5092"

      - name: Start Metro bundler
        working-directory: apps/mobile-app
        run: |
          # Start Metro bundler in background
          npx expo start --offline > /tmp/metro.log 2>&1 &
          METRO_PID=$!
          echo $METRO_PID > /tmp/metro.pid

          # Wait for Metro to be ready
          echo "Waiting for Metro bundler to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8081/status 2>/dev/null | grep -q "packager-status:running"; then
              echo "âœ… Metro bundler is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "::error::Metro bundler failed to start"
              cat /tmp/metro.log
              exit 1
            fi
            echo "Attempt $i: Metro not ready yet..."
            sleep 2
          done

  # iOS E2E Tests
  ios-e2e:
    name: iOS E2E Tests
    needs: setup
    if: needs.setup.outputs.ready == 'true'
    runs-on: macOS-ci
    timeout-minutes: 45
    defaults:
      run:
        working-directory: apps/mobile-app

    steps:
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Boot iOS Simulator
        run: |
          # Shutdown any existing simulators first
          xcrun simctl shutdown all || true

          # List available simulators
          xcrun simctl list devices available

          # Find and boot iPhone 16 Pro simulator (or fallback)
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 16 Pro" | head -1 | grep -oE '[A-F0-9-]{36}')

          if [ -z "$SIMULATOR_ID" ]; then
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 15 Pro" | head -1 | grep -oE '[A-F0-9-]{36}')
          fi

          if [ -z "$SIMULATOR_ID" ]; then
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[A-F0-9-]{36}')
          fi

          if [ -z "$SIMULATOR_ID" ]; then
            echo "::error::No iPhone simulator found!"
            exit 1
          fi

          echo "Booting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || true

          # Wait for simulator to be fully booted
          echo "Waiting for simulator to be ready..."
          xcrun simctl bootstatus "$SIMULATOR_ID" -b

          # Disable AutoFill to prevent "Save Password" prompts during tests
          echo "Disabling AutoFill in simulator..."
          xcrun simctl spawn "$SIMULATOR_ID" defaults write com.apple.Preferences AutoFillPasswords -bool NO || true
          xcrun simctl spawn "$SIMULATOR_ID" defaults write -g AutoFillPasswords -bool NO || true

          echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV
          echo "âœ… Simulator booted: $SIMULATOR_ID"

      - name: Build iOS app for testing
        run: |
          cd ios
          xcodebuild build-for-testing \
            -workspace AliasVault.xcworkspace \
            -scheme AliasVault \
            -sdk iphonesimulator \
            -destination "id=${{ env.SIMULATOR_ID }}" \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="-" \
            DEVELOPMENT_TEAM="" \
            IDEFileSystemSynchronizedGroupsAreEnabled=NO

      - name: Run iOS E2E Tests
        run: |
          cd ios
          xcodebuild test-without-building \
            -workspace AliasVault.xcworkspace \
            -scheme AliasVault \
            -sdk iphonesimulator \
            -destination "id=${{ env.SIMULATOR_ID }}" \
            -derivedDataPath build \
            -only-testing:AliasVaultUITests \
            -resultBundlePath TestResults.xcresult \
            -parallel-testing-enabled NO \
            -maximum-concurrent-test-simulator-destinations 1 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="-" \
            DEVELOPMENT_TEAM="" \
            IDEFileSystemSynchronizedGroupsAreEnabled=NO
        env:
          API_URL: "http://localhost:5092"

      - name: Shutdown iOS Simulator
        if: always()
        run: xcrun simctl shutdown all || true

      - name: Extract attachments from xcresult
        if: always()
        run: |
          mkdir -p /tmp/ios-test-attachments
          if [ -d "ios/TestResults.xcresult" ]; then
            xcrun xcresulttool get --path ios/TestResults.xcresult --format json > /tmp/ios-test-attachments/results.json 2>/dev/null || true
            xcrun xcresulttool export --path ios/TestResults.xcresult --output-path /tmp/ios-test-attachments --type file 2>/dev/null || true
            echo "Attachments found:"
            ls -la /tmp/ios-test-attachments/ || true
          fi

      - name: Upload iOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-test-results
          path: apps/mobile-app/ios/TestResults.xcresult
          retention-days: 14

      - name: Upload iOS test attachments
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-test-attachments
          path: /tmp/ios-test-attachments/
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload iOS logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-test-logs
          path: |
            /tmp/api-server.log
            /tmp/metro.log
          retention-days: 14
          if-no-files-found: ignore

  # Android E2E Tests (runs after iOS to avoid resource conflicts on single runner)
  android-e2e:
    name: Android E2E Tests
    needs: [setup, ios-e2e]
    if: always() && needs.setup.outputs.ready == 'true' && (needs.ios-e2e.result == 'success' || needs.ios-e2e.result == 'failure')
    runs-on: macOS-ci
    timeout-minutes: 45
    defaults:
      run:
        working-directory: apps/mobile-app

    steps:
      - name: Start Android emulator
        run: |
          # Check if emulator is already running
          if adb devices | grep -q "emulator"; then
            echo "Emulator already running, reusing..."
            EMULATOR_ID=$(adb devices | grep "emulator" | head -1 | awk '{print $1}')
          else
            # Start emulator in background
            echo "Starting Android emulator..."
            $ANDROID_HOME/emulator/emulator -avd Pixel_Pro_API_36 -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
            EMULATOR_PID=$!
            echo $EMULATOR_PID > /tmp/emulator.pid

            # Wait for emulator to be ready
            echo "Waiting for emulator to boot..."
            adb wait-for-device

            # Wait for boot to complete
            for i in {1..60}; do
              if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                echo "âœ… Emulator booted successfully!"
                break
              fi
              if [ $i -eq 60 ]; then
                echo "::error::Emulator failed to boot within 2 minutes"
                exit 1
              fi
              echo "Waiting for boot... attempt $i"
              sleep 2
            done

            EMULATOR_ID=$(adb devices | grep "emulator" | head -1 | awk '{print $1}')
          fi

          # Unlock screen
          adb -s $EMULATOR_ID shell input keyevent 82

          # Set up port forwarding
          adb -s $EMULATOR_ID reverse tcp:5092 tcp:5092
          adb -s $EMULATOR_ID reverse tcp:8081 tcp:8081

          echo "EMULATOR_ID=$EMULATOR_ID" >> $GITHUB_ENV
          echo "âœ… Emulator ready: $EMULATOR_ID"

      - name: Build and install Android APK
        run: |
          cd android
          ./gradlew :app:assembleDebug
          adb -s ${{ env.EMULATOR_ID }} install -r app/build/outputs/apk/debug/app-debug.apk

      - name: Run Android E2E Tests
        run: |
          cd android
          ./gradlew :app:connectedDebugAndroidTest \
            -Pandroid.testInstrumentationRunnerArguments.API_URL=http://10.0.2.2:5092 \
            --stacktrace
        env:
          API_URL: "http://10.0.2.2:5092"

      - name: Upload Android test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-test-results
          path: apps/mobile-app/android/app/build/reports/androidTests/
          retention-days: 14

      - name: Upload Android test outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-test-outputs
          path: apps/mobile-app/android/app/build/outputs/androidTest-results/
          retention-days: 14

      - name: Upload Android logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-test-logs
          path: |
            /tmp/api-server.log
            /tmp/metro.log
          retention-days: 14
          if-no-files-found: ignore

  # Cleanup job - stop shared services
  cleanup:
    name: Cleanup
    needs: [setup, ios-e2e, android-e2e]
    if: always()
    runs-on: macOS-ci
    steps:
      - name: Stop shared services
        run: |
          # Stop API server
          if [ -f /tmp/api-server.pid ]; then
            kill $(cat /tmp/api-server.pid) 2>/dev/null || true
            rm /tmp/api-server.pid
          fi
          # Stop Metro bundler
          if [ -f /tmp/metro.pid ]; then
            kill $(cat /tmp/metro.pid) 2>/dev/null || true
            rm /tmp/metro.pid
          fi
          # Kill any remaining processes
          pkill -f "dotnet.*AliasVault.Api" || true
          pkill -f "expo start" || true
          pkill -f "metro" || true
          echo "âœ… Cleanup complete"

      - name: Generate summary
        run: |
          echo "## Mobile E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.setup.result }}" == "failure" ]; then
            echo "âŒ **Setup failed** - Development database may not be running" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please ensure the dev database is running on the self-hosted runner:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo './install.sh configure-dev-db start' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.ios-e2e.result }}" == "success" ]; then
            echo "| iOS | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.ios-e2e.result }}" == "failure" ]; then
            echo "| iOS | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| iOS | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.android-e2e.result }}" == "success" ]; then
            echo "| Android | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.android-e2e.result }}" == "failure" ]; then
            echo "| Android | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Android | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # Fail if either test failed
          if [ "${{ needs.ios-e2e.result }}" == "failure" ] || [ "${{ needs.android-e2e.result }}" == "failure" ]; then
            exit 1
          fi
