@using AliasVault.ImportExport.Importers
@inject NavigationManager NavigationManager
@inject GlobalNotificationService GlobalNotificationService
@inject ILogger<ImportServiceBitwarden> Logger

<ImportServiceCard
    ServiceName="Bitwarden"
    Description="Import passwords from your Bitwarden vault"
    LogoUrl="img/importers/bitwarden.svg"
    OnImportComplete="RefreshVault"
    OnImportConfirmed="ProcessFile"
    @ref="_importServiceCard">
    <div class="mb-4">
        <p class="mb-4 text-gray-700 dark:text-gray-300">Upload your Bitwarden CSV export file:</p>
    </div>
    <InputFile OnChange="HandleFileUpload" />
</ImportServiceCard>

@code {
    private ImportServiceCard _importServiceCard = null!;

     private IBrowserFile? _selectedFile;

    private void HandleFileUpload(InputFileChangeEventArgs e)
    {
        Logger.LogInformation($"File selected: {e.File.Name}");
        _selectedFile = e.File;
    }

    private async Task ProcessFile()
    {
        if (_selectedFile == null)
        {
            Logger.LogWarning("No file selected for import");
            return;
        }

        Logger.LogInformation($"Processing KeePass file: {_selectedFile.Name}");

        try
        {
            await using var stream = _selectedFile.OpenReadStream();
            using var reader = new StreamReader(stream);
            var fileContents = await reader.ReadToEndAsync();

            var importCredentials = await BitwardenImporter.ImportFromCsvAsync(fileContents);
            _importServiceCard.SetImportedCredentials(importCredentials);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error processing KeePass CSV file");
            throw;
        }
    }
    private void RefreshVault()
    {
        GlobalNotificationService.AddSuccessMessage("Bitwarden CSV import successful!");
        NavigationManager.NavigateTo("/credentials");
    }
}
